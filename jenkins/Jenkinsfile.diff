lepipeline {
    agent any

    environment {
        TARGET_BRANCH = 'main'
    }

    stages {
        stage('Checkout') {
            steps {
                // ã‚¯ãƒ­ãƒ¼ãƒ³ã¨å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
                git branch: "${TARGET_BRANCH}", url: 'https://your.gitlab.repo/project.git'
            }
        }

        stage('Extract Changed Files') {
            steps {
                script {
                    // ã‚³ãƒŸãƒƒãƒˆãƒšã‚¢ã®ãƒªã‚¹ãƒˆï¼ˆå¿…è¦ã«å¿œã˜ã¦å¤–éƒ¨ã‹ã‚‰æ¸¡ã™ã“ã¨ã‚‚å¯ï¼‰
                    def commitPairs = [
                        ['abc123', 'def456'],
                        ['789abc', '012def']
                    ]

                    // ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
                    sh 'rm -f all_diff_files.txt merged_diff_files.txt existing_diff_files.txt'
                    sh 'touch all_diff_files.txt'

                    // å„ãƒšã‚¢ã®å·®åˆ†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŽé›†
                    for (pair in commitPairs) {
                        def c1 = pair[0]
                        def c2 = pair[1]
                        echo "ðŸ” Getting diff between ${c1} and ${c2}"
                        sh "git diff --name-only ${c1} ${c2} >> all_diff_files.txt"
                    }

                    // é‡è¤‡æŽ’é™¤
                    sh 'sort -u all_diff_files.txt > merged_diff_files.txt'

                    // HEADã«å­˜åœ¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿æŠ½å‡º
                    sh '''
                        git ls-tree -r --name-only HEAD > current_files.txt
                        grep -Fxf merged_diff_files.txt current_files.txt > existing_diff_files.txt
                    '''

                    // å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                    sh '''
                        mkdir -p diff_files
                        while IFS= read -r file; do
                          mkdir -p "diff_files/$(dirname "$file")"
                          cp "$file" "diff_files/$file"
                        done < existing_diff_files.txt
                    '''
                }
            }
        }

        stage('Analyze') {
            steps {
                echo 'ðŸ§ª Run analysis tools on diff_files/*'
                // ã“ã“ã§é™çš„è§£æžã‚„ãƒ“ãƒ«ãƒ‰å¯¾è±¡ã«ã™ã‚‹
                // ä¾‹:
                // sh 'pmd -d diff_files -R ruleset.xml -f text'
            }
        }
    }
}
